const USER_NAME_SESSION_KEY = 'USER_NAME';

var db = require('db');

var loggedIn = function(session) {
    return typeof session[USER_NAME_SESSION_KEY] != 'undefined'
            && session[USER_NAME_SESSION_KEY] != null;
};

exports.getCurrentUsername = function(req) {
    return req.session[USER_NAME_SESSION_KEY];
};

exports.aclMiddleWare = function() {
    var bypassed = [];
    for (var i = 0, l = arguments.length; i < l; i++) {
        bypassed.push(arguments[i]);
    }
    var url = require('url');

    return function(req, resp, next) {

        var path = url.parse(req.url).pathname;

        var shouldPassed = false;
        for (var i = 0, l = bypassed.length; i < l; i++) {
            if (path == bypassed[i]) {
                shouldPassed = true;
                break;
            }
        }

        (shouldPassed || loggedIn(req.session)) ? next() : resp.redirect("/index.html");
    }
};

exports.login = function(req, res) {

    var field = 'user:' + req.body.username + ':passwd';
    db.get(field, function(passwd) {
        if (passwd === req.body.passwd) {
            req.session[USER_NAME_SESSION_KEY] = req.body.username;
            res.write(JSON.stringify({success:true, message:'successfully logged in.'}));
            res.end();
        } else {
            res.write(JSON.stringify({success:false, message:'invalid username / passwd combination.'}));
            res.end();
        }
    });

};