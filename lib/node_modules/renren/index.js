var holder = {};
(function() {
    var acl = require('acl');
    var db = require('db');
    var auth = require('./auth');
    holder.authCode = function(req, res, code) {
        var username = acl.getCurrentUsername(req);
        auth.requestToken(code, function(renrenResponse) {
            db.set('renren:' + username + ':authInfo', renrenResponse);
            res.redirect('/static/auth.html');
            res.end();
        });
    };

    holder.updateStatus = function(username, status, successCallback) {
        db.get('renren:' + username + ':authInfo', function(dbReply) {
            if (dbReply) {
                var authInfo = JSON.parse(dbReply);
                require('./status').update(authInfo.access_token, status, successCallback);
            }
        });
    }

})();

module.exports.authCode = function(req, res) {
    holder.authCode(req, res, req.query.code);
};
module.exports.updateStatus = holder.updateStatus;


// todo felix debug purpose
//module.exports.httpUpdateStatus = function(req, res) {
//
//    holder.updateStatus(req.query.username,req.query.status);
//    res.write('issued');
//    res.end();
//
//};